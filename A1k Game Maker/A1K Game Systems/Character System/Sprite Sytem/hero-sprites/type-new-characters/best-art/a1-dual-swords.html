<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A1 Dual Swords - Production Ready 3D Character</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
    <script src="shared/particle-system.js"></script>
    <script src="shared/post-processing.js"></script>
    <script src="shared/animation-system.js"></script>
    <script src="shared/audio-system.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
        }

        #container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            width: 100%;
        }

        #viewport {
            flex: 1;
            border: 4px solid #e94560;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(233, 69, 96, 0.3), 0 0 60px rgba(233, 69, 96, 0.1);
            overflow: hidden;
            background: #000;
        }

        #controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 4px solid #e94560;
            border-radius: 15px;
            padding: 25px;
            width: 320px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 22px;
            color: #e94560;
            border-bottom: 3px solid #e94560;
            padding-bottom: 12px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(233, 69, 96, 0.2);
        }

        .control-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #16213e;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #e94560;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select {
            background: #f8f9fa;
            color: #16213e;
        }

        select:hover {
            background: #fff;
            box-shadow: 0 2px 8px rgba(233, 69, 96, 0.2);
        }

        button {
            background: linear-gradient(135deg, #e94560 0%, #d63447 100%);
            color: white;
            border: none;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(233, 69, 96, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .info {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            margin-top: 20px;
            line-height: 1.6;
        }

        .info strong {
            color: #e94560;
        }

        @media (max-width: 1200px) {
            #container {
                flex-direction: column;
            }
            #controls {
                width: 100%;
                max-width: 600px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="viewport"></div>
        <div id="controls">
            <h1>‚öîÔ∏è A1 WARRIOR</h1>
            
            <div class="control-group">
                <label>Animation State</label>
                <select id="animState">
                    <option value="idle">Idle - Ready Stance</option>
                    <option value="walk">Walk - Movement</option>
                    <option value="attack">Attack - Sword Slash</option>
                    <option value="jump">Jump - Leap</option>
                    <option value="dodge">Dodge - Evade</option>
                    <option value="special1">Special 1 - Spin Attack</option>
                    <option value="special2">Special 2 - Ground Slam</option>
                    <option value="hit">Hit - Stagger</option>
                    <option value="victory">Victory - Celebrate</option>
                    <option value="defeat">Defeat - Fall</option>
                    <option value="charge">Charge - Power Up</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Combo Counter: <span id="comboDisplay">0</span></label>
            </div>

            <div class="control-group">
                <label>Audio</label>
                <button id="audioToggle" style="width: 100%;">üîä Audio ON</button>
            </div>

            <div class="control-group">
                <label>Sword Color Theme</label>
                <select id="swordColor">
                    <option value="fire">Fire - Red Blades</option>
                    <option value="ice">Ice - Cyan Blades</option>
                    <option value="shadow">Shadow - Purple Blades</option>
                    <option value="lightning">Lightning - Yellow Blades</option>
                    <option value="toxic">Toxic - Green Blades</option>
                </select>
            </div>

            <div class="control-group">
                <label>Particle Effects</label>
                <select id="particleToggle">
                    <option value="all">All Effects ON</option>
                    <option value="trails">Trails Only</option>
                    <option value="ambient">Ambient Only</option>
                    <option value="off">Effects OFF</option>
                </select>
            </div>

            <div class="control-group">
                <label>Visual Style</label>
                <select id="colorGrading">
                    <option value="default">Default</option>
                    <option value="cinematic">Cinematic</option>
                    <option value="vibrant">Vibrant</option>
                    <option value="moody">Moody</option>
                    <option value="warm">Warm</option>
                    <option value="cool">Cool</option>
                    <option value="cyberpunk">Cyberpunk</option>
                </select>
            </div>

            <div class="control-group">
                <label>Screen Effects</label>
                <select id="screenEffects">
                    <option value="none">None</option>
                    <option value="vignette">Vignette</option>
                    <option value="filmgrain">Film Grain</option>
                    <option value="scanlines">Scanlines</option>
                    <option value="chromatic">Chromatic</option>
                    <option value="all">All Effects</option>
                </select>
            </div>

            <div class="control-group">
                <label>Export Options</label>
                <button id="exportPNG">üì∏ Export PNG (512x512)</button>
                <button id="exportPNGHD">üì∏ Export PNG HD (1024x1024)</button>
                <button id="exportTransparent">üì∏ Export Transparent BG</button>
            </div>

            <div class="info">
                <strong>Production Ready Character</strong><br>
                ‚Ä¢ Smooth multi-state animations<br>
                ‚Ä¢ Enhanced low-poly geometry<br>
                ‚Ä¢ Dynamic lighting & effects<br>
                ‚Ä¢ Optimized for 60 FPS<br>
                ‚Ä¢ Ready for game integration
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // PRODUCTION-READY A1 DUAL SWORDS CHARACTER
        // ============================================

        let scene, camera, renderer, warrior;
        let animationState = 'idle';
        let animationTime = 0;
        let transitionProgress = 0;
        let previousState = 'idle';
        const TRANSITION_SPEED = 0.1;

        // Sword color palettes with emissive values
        const swordPalettes = {
            fire: { color: 0xff3333, emissive: 0xff0000, intensity: 0.8 },
            ice: { color: 0x33ffff, emissive: 0x00ccff, intensity: 0.7 },
            shadow: { color: 0xaa44ff, emissive: 0x8800ff, intensity: 0.6 },
            lightning: { color: 0xffff33, emissive: 0xffdd00, intensity: 0.9 },
            toxic: { color: 0x33ff66, emissive: 0x00ff44, intensity: 0.7 }
        };

        let currentSwordPalette = swordPalettes.fire;
        
        // Particle system
        let particleSystem;
        let leftSwordTrail, rightSwordTrail;
        let particleMode = 'all'; // all, trails, ambient, off
        let lastAmbientEmit = 0;
        let lastWalkDust = 0;
        
        // Post-processing
        let postProcessing;
        
        // Extended animation system
        let animSystem;
        let animController;
        
        // Audio system
        let audioSystem;

        // Character body parts references
        let bodyParts = {
            head: null,
            body: null,
            leftArm: null,
            rightArm: null,
            leftLeg: null,
            rightLeg: null,
            leftSword: null,
            rightSword: null,
            leftEye: null,
            rightEye: null,
            hair: null,
            cap: null
        };

        // ============================================
        // INITIALIZATION
        // ============================================

        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            scene.fog = new THREE.Fog(0x000000, 5, 15);

            // Camera setup
            camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
            camera.position.set(0, 1.8, 5);
            camera.lookAt(0, 1.2, 0);

            // Renderer setup with enhanced settings
            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                preserveDrawingBuffer: true,
                alpha: true
            });
            renderer.setSize(512, 512);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('viewport').appendChild(renderer.domElement);

            // Enhanced lighting setup
            setupLighting();

            // Create the warrior character
            createWarrior();
            
            // Initialize particle system
            particleSystem = new ParticleSystem(scene);
            
            // Create weapon trail trackers
            leftSwordTrail = new WeaponTrailTracker(
                particleSystem,
                bodyParts.leftSword,
                currentSwordPalette.emissive
            );
            rightSwordTrail = new WeaponTrailTracker(
                particleSystem,
                bodyParts.rightSword,
                currentSwordPalette.emissive
            );
            
            // Initialize post-processing
            postProcessing = new PostProcessing(renderer, scene, camera);
            
            // Initialize extended animation system
            animSystem = new AnimationSystem();
            animController = new CharacterAnimationController(bodyParts);
            
            // Initialize audio system
            audioSystem = new AudioSystem();

            // Start animation loop
            animate();

            // Setup event listeners
            setupEventListeners();
        }

        // ============================================
        // LIGHTING SETUP
        // ============================================

        function setupLighting() {
            // Ambient light for base illumination
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            // Main directional light (key light)
            const mainLight = new THREE.DirectionalLight(0xffffff, 1.0);
            mainLight.position.set(5, 10, 7);
            mainLight.castShadow = true;
            mainLight.shadow.mapSize.width = 2048;
            mainLight.shadow.mapSize.height = 2048;
            scene.add(mainLight);

            // Rim light (back light for silhouette)
            const rimLight = new THREE.DirectionalLight(0x4488ff, 0.5);
            rimLight.position.set(-5, 5, -5);
            scene.add(rimLight);

            // Fill light (soften shadows)
            const fillLight = new THREE.DirectionalLight(0xffddcc, 0.3);
            fillLight.position.set(-3, 2, 5);
            scene.add(fillLight);

            // Accent point light (for weapon glow effect)
            const accentLight = new THREE.PointLight(0xff3333, 0.8, 10);
            accentLight.position.set(0, 1.5, 1);
            scene.add(accentLight);
            
            // Update accent light color with sword palette
            window.accentLight = accentLight;
        }

        // ============================================
        // CHARACTER CREATION
        // ============================================

        function createWarrior() {
            warrior = new THREE.Group();

            // Material definitions with enhanced properties
            const matBody = new THREE.MeshPhongMaterial({ 
                color: 0x1a1a2e, 
                flatShading: true,
                shininess: 30,
                specular: 0x333366
            });

            const matSkin = new THREE.MeshPhongMaterial({ 
                color: 0x8b4513, 
                flatShading: true,
                shininess: 10,
                specular: 0x442211
            });

            const matHair = new THREE.MeshPhongMaterial({ 
                color: 0x1a1a1a, 
                flatShading: true,
                shininess: 50
            });

            const matCap = new THREE.MeshPhongMaterial({ 
                color: 0x0a0a0a, 
                flatShading: true,
                shininess: 20
            });

            const matEye = new THREE.MeshPhongMaterial({ 
                color: 0xff0000, 
                flatShading: true,
                emissive: 0xff0000,
                emissiveIntensity: 0.8
            });

            const matSword = new THREE.MeshPhongMaterial({ 
                color: currentSwordPalette.color, 
                flatShading: true,
                emissive: currentSwordPalette.emissive,
                emissiveIntensity: currentSwordPalette.intensity,
                shininess: 100,
                specular: 0xffffff
            });

            // Body (torso with more detail)
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.7, 0.35), matBody);
            body.position.y = 1.0;
            body.castShadow = true;
            bodyParts.body = body;
            warrior.add(body);

            // Belt detail
            const belt = new THREE.Mesh(new THREE.BoxGeometry(0.52, 0.1, 0.36), new THREE.MeshPhongMaterial({ 
                color: 0x2a2a3e, 
                flatShading: true 
            }));
            belt.position.y = 0.7;
            warrior.add(belt);

            // Head (with more defined shape)
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.35), matSkin);
            head.position.y = 1.6;
            head.castShadow = true;
            bodyParts.head = head;
            warrior.add(head);

            // Cap/Hat
            const cap = new THREE.Mesh(new THREE.BoxGeometry(0.42, 0.15, 0.37), matCap);
            cap.position.y = 1.75;
            bodyParts.cap = cap;
            warrior.add(cap);

            // Cap visor
            const visor = new THREE.Mesh(new THREE.BoxGeometry(0.43, 0.05, 0.15), matCap);
            visor.position.set(0, 1.65, 0.2);
            warrior.add(visor);

            // Hair (curly, visible under cap)
            const hair = new THREE.Mesh(new THREE.BoxGeometry(0.38, 0.2, 0.33), matHair);
            hair.position.y = 1.55;
            bodyParts.hair = hair;
            warrior.add(hair);

            // Glowing red eyes
            const leftEye = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.08, 0.05), matEye);
            leftEye.position.set(-0.1, 1.6, 0.18);
            bodyParts.leftEye = leftEye;
            warrior.add(leftEye);

            const rightEye = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.08, 0.05), matEye);
            rightEye.position.set(0.1, 1.6, 0.18);
            bodyParts.rightEye = rightEye;
            warrior.add(rightEye);

            // Legs with more detail
            const leftLeg = new THREE.Mesh(new THREE.BoxGeometry(0.18, 0.6, 0.18), matBody);
            leftLeg.position.set(-0.15, 0.3, 0);
            leftLeg.castShadow = true;
            bodyParts.leftLeg = leftLeg;
            warrior.add(leftLeg);

            const rightLeg = new THREE.Mesh(new THREE.BoxGeometry(0.18, 0.6, 0.18), matBody);
            rightLeg.position.set(0.15, 0.3, 0);
            rightLeg.castShadow = true;
            bodyParts.rightLeg = rightLeg;
            warrior.add(rightLeg);

            // Arms with elbow joints
            const leftShoulder = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.2, 0.15), matBody);
            leftShoulder.position.set(-0.32, 1.15, 0);
            warrior.add(leftShoulder);

            const leftArm = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.45, 0.12), matSkin);
            leftArm.position.set(-0.38, 0.85, 0);
            leftArm.castShadow = true;
            bodyParts.leftArm = leftArm;
            warrior.add(leftArm);

            const rightShoulder = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.2, 0.15), matBody);
            rightShoulder.position.set(0.32, 1.15, 0);
            warrior.add(rightShoulder);

            const rightArm = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.45, 0.12), matSkin);
            rightArm.position.set(0.38, 0.85, 0);
            rightArm.castShadow = true;
            bodyParts.rightArm = rightArm;
            warrior.add(rightArm);

            // Left Sword (enhanced with guard and grip)
            const leftSwordBlade = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.7, 0.03), matSword);
            leftSwordBlade.position.set(-0.5, 0.9, 0);
            bodyParts.leftSword = leftSwordBlade;
            warrior.add(leftSwordBlade);

            const leftSwordGuard = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.03, 0.05), matSword);
            leftSwordGuard.position.set(-0.5, 0.55, 0);
            warrior.add(leftSwordGuard);

            const leftSwordGrip = new THREE.Mesh(new THREE.BoxGeometry(0.04, 0.15, 0.04), new THREE.MeshPhongMaterial({ 
                color: 0x2a2a2a, 
                flatShading: true 
            }));
            leftSwordGrip.position.set(-0.5, 0.45, 0);
            warrior.add(leftSwordGrip);

            // Right Sword (enhanced with guard and grip)
            const rightSwordBlade = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.7, 0.03), matSword);
            rightSwordBlade.position.set(0.5, 0.9, 0);
            bodyParts.rightSword = rightSwordBlade;
            warrior.add(rightSwordBlade);

            const rightSwordGuard = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.03, 0.05), matSword);
            rightSwordGuard.position.set(0.5, 0.55, 0);
            warrior.add(rightSwordGuard);

            const rightSwordGrip = new THREE.Mesh(new THREE.BoxGeometry(0.04, 0.15, 0.04), new THREE.MeshPhongMaterial({ 
                color: 0x2a2a2a, 
                flatShading: true 
            }));
            rightSwordGrip.position.set(0.5, 0.45, 0);
            warrior.add(rightSwordGrip);

            scene.add(warrior);
        }

        // ============================================
        // ANIMATION SYSTEM
        // ============================================

        function updateAnimation(deltaTime) {
            animationTime += deltaTime;
            
            // Update animation system
            if (animSystem) {
                const prevState = animationState;
                animSystem.update(deltaTime);
                animationState = animSystem.getCurrentState();
                
                // Play sound on state change
                if (prevState !== animationState && audioSystem) {
                    audioSystem.playAnimationSound(animationState, 'a1');
                }
                
                // Update combo display
                const comboDisplay = document.getElementById('comboDisplay');
                if (comboDisplay) {
                    comboDisplay.textContent = animSystem.getComboCount();
                }
            }

            // Get normalized animation time
            const progress = animSystem ? animSystem.getNormalizedTime() : 0;

            // Execute animation based on current state
            switch (animationState) {
                case 'idle':
                    animateIdle();
                    break;
                case 'walk':
                    animateWalk();
                    break;
                case 'attack':
                    animateAttack();
                    break;
                case 'jump':
                    if (animController) animController.animateJump(progress);
                    break;
                case 'dodge':
                    if (animController) animController.animateDodge(progress);
                    break;
                case 'special1':
                    if (animController) animController.animateSpecial1(progress);
                    // Enhanced effects for special
                    if (particleMode === 'all' && progress > 0.3 && progress < 0.7) {
                        const leftPos = new THREE.Vector3();
                        const rightPos = new THREE.Vector3();
                        bodyParts.leftSword.getWorldPosition(leftPos);
                        bodyParts.rightSword.getWorldPosition(rightPos);
                        particleSystem.emitSwordImpact(leftPos, currentSwordPalette.emissive, 1.5);
                        particleSystem.emitSwordImpact(rightPos, currentSwordPalette.emissive, 1.5);
                    }
                    break;
                case 'special2':
                    if (animController) animController.animateSpecial2(progress);
                    // Ground slam impact
                    if (particleMode === 'all' && progress > 0.6 && progress < 0.65) {
                        for (let i = 0; i < 8; i++) {
                            const angle = (i / 8) * Math.PI * 2;
                            const pos = new THREE.Vector3(
                                Math.cos(angle) * 0.5,
                                0,
                                Math.sin(angle) * 0.5
                            );
                            particleSystem.emitParticles({
                                position: pos,
                                count: 5,
                                color: currentSwordPalette.emissive,
                                velocity: { x: Math.cos(angle), y: 0.5, z: Math.sin(angle) },
                                spread: 0.3,
                                life: 0.8,
                                size: 0.04,
                                gravity: -1
                            });
                        }
                    }
                    break;
                case 'hit':
                    if (animController) animController.animateHit(progress);
                    break;
                case 'victory':
                    if (animController) animController.animateVictory(animSystem.stateTime);
                    // Victory sparkles
                    if (particleMode === 'all' && Math.random() < 0.1) {
                        const pos = new THREE.Vector3(
                            (Math.random() - 0.5) * 0.8,
                            0.5 + Math.random() * 1.5,
                            (Math.random() - 0.5) * 0.5
                        );
                        particleSystem.emitParticles({
                            position: pos,
                            count: 1,
                            color: 0xffff00,
                            velocity: { x: 0, y: 0.2, z: 0 },
                            spread: 0.1,
                            life: 1.0,
                            size: 0.02,
                            gravity: 0
                        });
                    }
                    break;
                case 'defeat':
                    if (animController) animController.animateDefeat(progress);
                    break;
                case 'charge':
                    if (animController) animController.animateCharge(animSystem.stateTime);
                    // Charging energy particles
                    if (particleMode === 'all' && Math.random() < 0.2) {
                        const angle = Math.random() * Math.PI * 2;
                        const radius = 0.8 + Math.random() * 0.4;
                        const pos = new THREE.Vector3(
                            Math.cos(angle) * radius,
                            0.5 + Math.random() * 1.0,
                            Math.sin(angle) * radius
                        );
                        particleSystem.emitParticles({
                            position: pos,
                            count: 1,
                            color: currentSwordPalette.emissive,
                            velocity: { x: -Math.cos(angle) * 2, y: 0, z: -Math.sin(angle) * 2 },
                            spread: 0.1,
                            life: 0.5,
                            size: 0.03,
                            gravity: 0
                        });
                    }
                    break;
            }

            // Continuous slow rotation for display
            warrior.rotation.y = Math.sin(animationTime * 0.0003) * 0.3;
        }

        function animateIdle() {
            const t = animationTime * 0.001;
            const breathe = Math.sin(t * 2) * 0.015;
            const sway = Math.sin(t * 1.5) * 0.02;

            // Gentle breathing
            if (bodyParts.body) {
                bodyParts.body.scale.y = 1 + breathe * 0.5;
                bodyParts.body.position.y = 1.0 + breathe * 2;
            }

            // Head slight movement
            if (bodyParts.head) {
                bodyParts.head.position.y = 1.6 + breathe * 1.5;
                bodyParts.head.rotation.z = sway * 0.5;
            }

            // Subtle weapon bob
            if (bodyParts.leftSword) {
                bodyParts.leftSword.position.y = 0.9 + Math.sin(t * 2 + 0.5) * 0.02;
            }
            if (bodyParts.rightSword) {
                bodyParts.rightSword.position.y = 0.9 + Math.sin(t * 2) * 0.02;
            }

            // Eye glow pulse
            const eyePulse = 0.6 + Math.sin(t * 3) * 0.2;
            if (bodyParts.leftEye) bodyParts.leftEye.material.emissiveIntensity = eyePulse;
            if (bodyParts.rightEye) bodyParts.rightEye.material.emissiveIntensity = eyePulse;
            
            // Ambient particles
            if ((particleMode === 'all' || particleMode === 'ambient') && Date.now() - lastAmbientEmit > 200) {
                const pos = new THREE.Vector3(0, 1.2, 0);
                particleSystem.emitAmbientAura(pos, currentSwordPalette.emissive, 0.8);
                particleSystem.emitEnergyOrb(pos, currentSwordPalette.emissive, 2);
                lastAmbientEmit = Date.now();
            }
        }

        function animateWalk() {
            const t = animationTime * 0.003;
            const walkCycle = Math.sin(t * 4);
            const walkCycleCos = Math.cos(t * 4);

            // Body bob
            if (bodyParts.body) {
                bodyParts.body.position.y = 1.0 + Math.abs(walkCycle) * 0.08;
                bodyParts.body.rotation.z = walkCycle * 0.1;
            }

            // Head movement
            if (bodyParts.head) {
                bodyParts.head.position.y = 1.6 + Math.abs(walkCycle) * 0.08;
                bodyParts.head.rotation.z = walkCycle * 0.05;
            }

            // Leg swing (opposite phases)
            if (bodyParts.leftLeg) {
                bodyParts.leftLeg.rotation.x = walkCycle * 0.5;
                bodyParts.leftLeg.position.y = 0.3 + Math.max(0, walkCycle * 0.1);
            }
            if (bodyParts.rightLeg) {
                bodyParts.rightLeg.rotation.x = -walkCycle * 0.5;
                bodyParts.rightLeg.position.y = 0.3 + Math.max(0, -walkCycle * 0.1);
            }

            // Arm swing (opposite to legs)
            if (bodyParts.leftArm) {
                bodyParts.leftArm.rotation.x = -walkCycleCos * 0.4;
            }
            if (bodyParts.rightArm) {
                bodyParts.rightArm.rotation.x = walkCycleCos * 0.4;
            }

            // Sword momentum
            if (bodyParts.leftSword) {
                bodyParts.leftSword.rotation.x = -walkCycleCos * 0.3;
                bodyParts.leftSword.position.y = 0.9 + Math.abs(walkCycleCos) * 0.05;
            }
            if (bodyParts.rightSword) {
                bodyParts.rightSword.rotation.x = walkCycleCos * 0.3;
                bodyParts.rightSword.position.y = 0.9 + Math.abs(walkCycle) * 0.05;
            }
            
            // Walk dust particles
            if ((particleMode === 'all' || particleMode === 'ambient') && Date.now() - lastWalkDust > 300) {
                const footPos = new THREE.Vector3(walkCycle > 0 ? -0.15 : 0.15, 0, 0);
                particleSystem.emitWalkDust(footPos);
                lastWalkDust = Date.now();
            }
        }

        function animateAttack() {
            const t = animationTime * 0.005;
            const attackCycle = Math.sin(t * 3);
            const attackProgress = (Math.sin(t * 3) + 1) / 2; // 0 to 1

            // Body lean into attack
            if (bodyParts.body) {
                bodyParts.body.rotation.z = attackCycle * 0.2;
                bodyParts.body.position.z = attackCycle * 0.1;
            }

            // Head follows body
            if (bodyParts.head) {
                bodyParts.head.rotation.z = attackCycle * 0.15;
            }

            // Dramatic sword swings (cross pattern)
            if (bodyParts.leftSword) {
                const leftSwing = Math.sin(t * 3) * 1.2;
                bodyParts.leftSword.rotation.z = leftSwing;
                bodyParts.leftSword.rotation.x = Math.cos(t * 3) * 0.5;
                bodyParts.leftSword.position.z = Math.sin(t * 3) * 0.3;
                
                // Enhance glow during peak of swing
                if (attackProgress > 0.4 && attackProgress < 0.6) {
                    bodyParts.leftSword.material.emissiveIntensity = currentSwordPalette.intensity * 1.5;
                } else {
                    bodyParts.leftSword.material.emissiveIntensity = currentSwordPalette.intensity;
                }
            }

            if (bodyParts.rightSword) {
                const rightSwing = Math.sin(t * 3 + Math.PI) * 1.2;
                bodyParts.rightSword.rotation.z = rightSwing;
                bodyParts.rightSword.rotation.x = Math.cos(t * 3 + Math.PI) * 0.5;
                bodyParts.rightSword.position.z = Math.sin(t * 3 + Math.PI) * 0.3;
                
                // Enhance glow during peak of swing
                if (attackProgress > 0.4 && attackProgress < 0.6) {
                    bodyParts.rightSword.material.emissiveIntensity = currentSwordPalette.intensity * 1.5;
                } else {
                    bodyParts.rightSword.material.emissiveIntensity = currentSwordPalette.intensity;
                }
            }

            // Arms follow sword movement
            if (bodyParts.leftArm) {
                bodyParts.leftArm.rotation.z = Math.sin(t * 3) * 0.6;
            }
            if (bodyParts.rightArm) {
                bodyParts.rightArm.rotation.z = Math.sin(t * 3 + Math.PI) * -0.6;
            }

            // Eyes intensify during attack
            const eyeIntensity = 0.8 + attackProgress * 0.4;
            if (bodyParts.leftEye) bodyParts.leftEye.material.emissiveIntensity = eyeIntensity;
            if (bodyParts.rightEye) bodyParts.rightEye.material.emissiveIntensity = eyeIntensity;
            
            // Weapon trails during attack
            if (particleMode === 'all' || particleMode === 'trails') {
                leftSwordTrail.enable();
                rightSwordTrail.enable();
                leftSwordTrail.setIntensity(1.5);
                rightSwordTrail.setIntensity(1.5);
            } else {
                leftSwordTrail.disable();
                rightSwordTrail.disable();
            }
            
            // Impact particles at peak of swings
            if ((particleMode === 'all') && (attackProgress > 0.48 && attackProgress < 0.52)) {
                const leftPos = new THREE.Vector3();
                const rightPos = new THREE.Vector3();
                bodyParts.leftSword.getWorldPosition(leftPos);
                bodyParts.rightSword.getWorldPosition(rightPos);
                particleSystem.emitSwordImpact(leftPos, currentSwordPalette.emissive, 1.0);
                particleSystem.emitSwordImpact(rightPos, currentSwordPalette.emissive, 1.0);
            }
        }

        // ============================================
        // ANIMATION LOOP
        // ============================================

        let lastTime = performance.now();

        function animate() {
            requestAnimationFrame(animate);

            const currentTime = performance.now();
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;

            // Update animations
            updateAnimation(deltaTime);
            
            // Update particle system
            if (particleSystem) {
                particleSystem.update(deltaTime);
            }
            
            // Update weapon trails
            if (leftSwordTrail && rightSwordTrail) {
                leftSwordTrail.update();
                rightSwordTrail.update();
            }

            // Render with post-processing
            if (postProcessing) {
                postProcessing.render();
            } else {
                renderer.render(scene, camera);
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        function setupEventListeners() {
            // Animation state change
            document.getElementById('animState').addEventListener('change', (e) => {
                const newState = e.target.value;
                if (animSystem) {
                    animSystem.setState(newState);
                } else {
                    previousState = animationState;
                    animationState = newState;
                    transitionProgress = 0;
                }
                
                // Reset body parts to neutral positions for smooth transition
                if (animController) {
                    animController.resetToBase();
                } else {
                    resetBodyParts();
                }
            });

            // Sword color change
            document.getElementById('swordColor').addEventListener('change', (e) => {
                const paletteKey = e.target.value;
                currentSwordPalette = swordPalettes[paletteKey];
                
                // Update sword materials
                warrior.children.forEach(child => {
                    if (child.material && child.material.emissive) {
                        const isGlowingPart = child.position.x !== 0 && 
                                             (Math.abs(child.position.x) > 0.4 || 
                                              child.geometry.parameters.height > 0.5);
                        if (isGlowingPart) {
                            child.material.color.setHex(currentSwordPalette.color);
                            child.material.emissive.setHex(currentSwordPalette.emissive);
                            child.material.emissiveIntensity = currentSwordPalette.intensity;
                        }
                    }
                });

                // Update accent light color
                if (window.accentLight) {
                    window.accentLight.color.setHex(currentSwordPalette.emissive);
                }
                
                // Update trail colors
                if (leftSwordTrail && rightSwordTrail) {
                    leftSwordTrail.setColor(currentSwordPalette.emissive);
                    rightSwordTrail.setColor(currentSwordPalette.emissive);
                }
            });
            
            // Particle effects toggle
            document.getElementById('particleToggle').addEventListener('change', (e) => {
                particleMode = e.target.value;
                
                // Disable trails if not in attack mode
                if (animationState !== 'attack') {
                    leftSwordTrail.disable();
                    rightSwordTrail.disable();
                }
            });
            
            // Color grading
            document.getElementById('colorGrading').addEventListener('change', (e) => {
                if (postProcessing) {
                    postProcessing.setColorGrading(e.target.value);
                }
            });
            
            // Screen effects
            document.getElementById('screenEffects').addEventListener('change', (e) => {
                if (postProcessing) {
                    const effect = e.target.value;
                    // Reset all effects
                    postProcessing.setVignette(false);
                    postProcessing.setFilmGrain(false);
                    postProcessing.setScanlines(false);
                    postProcessing.setChromaticAberration(false);
                    
                    // Enable selected effect
                    switch(effect) {
                        case 'vignette':
                            postProcessing.setVignette(true, 0.6, 0.5);
                            break;
                        case 'filmgrain':
                            postProcessing.setFilmGrain(true, 0.15);
                            break;
                        case 'scanlines':
                            postProcessing.setScanlines(true, 4, 0.3);
                            break;
                        case 'chromatic':
                            postProcessing.setChromaticAberration(true, 0.003);
                            break;
                        case 'all':
                            postProcessing.setVignette(true, 0.5, 0.5);
                            postProcessing.setFilmGrain(true, 0.1);
                            postProcessing.setScanlines(true, 3, 0.2);
                            break;
                    }
                }
            });

            // Audio toggle
            document.getElementById('audioToggle').addEventListener('click', (e) => {
                if (audioSystem) {
                    const enabled = audioSystem.toggle();
                    e.target.textContent = enabled ? 'üîä Audio ON' : 'üîá Audio OFF';
                }
            });

            // Export PNG 512x512
            document.getElementById('exportPNG').addEventListener('click', () => {
                exportImage(512, false, 'a1-warrior-512.png');
            });

            // Export PNG HD 1024x1024
            document.getElementById('exportPNGHD').addEventListener('click', () => {
                exportImage(1024, false, 'a1-warrior-1024.png');
            });

            // Export with transparent background
            document.getElementById('exportTransparent').addEventListener('click', () => {
                exportImage(512, true, 'a1-warrior-transparent.png');
            });
        }

        // ============================================
        // EXPORT FUNCTIONALITY
        // ============================================

        function exportImage(size, transparent, filename) {
            // Store current settings
            const originalSize = renderer.domElement.width;
            const originalBg = scene.background;

            // Set transparent background if requested
            if (transparent) {
                scene.background = null;
            }

            // Render at requested size
            renderer.setSize(size, size);
            renderer.render(scene, camera);

            // Create download link
            const link = document.createElement('a');
            link.download = filename;
            link.href = renderer.domElement.toDataURL('image/png');
            link.click();

            // Restore original settings
            renderer.setSize(originalSize, originalSize);
            scene.background = originalBg;
            renderer.render(scene, camera);

            console.log(`Exported: ${filename} (${size}x${size})`);
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function resetBodyParts() {
            // Reset rotations and positions for smooth transitions
            Object.keys(bodyParts).forEach(key => {
                const part = bodyParts[key];
                if (part) {
                    part.rotation.x = 0;
                    part.rotation.z = 0;
                    part.scale.set(1, 1, 1);
                }
            });
        }

        // ============================================
        // START APPLICATION
        // ============================================

        init();
    </script>
</body>
</html>

